name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            build_cmd: npm run build:linux
            package_cmd: tar -czf myanimelist-on-stream-linux.tar.gz -C dist .
            artifact_name: myanimelist-on-stream-linux
            artifact_path: myanimelist-on-stream-linux.tar.gz
          - os: windows-latest
            build_cmd: npm run build:win
            package_cmd: powershell Compress-Archive -Force -Path dist\* -DestinationPath myanimelist-on-stream-windows.zip
            artifact_name: myanimelist-on-stream-windows
            artifact_path: myanimelist-on-stream-windows.zip

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Build binary
        run: |
          npm run clean || true
          npm run build --if-present
          ${{ matrix.build_cmd }}
      - name: Package artifact
        run: ${{ matrix.package_cmd }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

  build-obs-plugin:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact_name: obs-mal-scroll-linux
            artifact_file: obs-mal-scroll-linux.tar.gz
          - os: windows-latest
            artifact_name: obs-mal-scroll-windows
            artifact_file: obs-mal-scroll-windows.zip

    steps:
      - uses: actions/checkout@v4

      - name: Clean tracked build artifacts
        shell: bash
        run: |
          rm -rf obs-plugin/build obs-plugin/flatpak-build
      
      - name: Install OBS Studio (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo add-apt-repository ppa:obsproject/obs-studio -y
          sudo apt-get update
          sudo apt-get install -y libobs-dev libcurl4-openssl-dev nlohmann-json3-dev cmake build-essential pkg-config


      - name: Install vcpkg dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg install curl:x64-windows

      - name: Build OBS Plugin (Linux)
        if: runner.os == 'Linux'
        run: |
          rm -rf obs-plugin/build
          OBS_CMAKE_PREFIX=/usr/lib/x86_64-linux-gnu/cmake/obs
          OBS_CMAKE_MODULE=/usr/lib/x86_64-linux-gnu/cmake/obs
          LOCAL_MODULE="$(pwd)/obs-plugin/cmake"
          cmake -S obs-plugin -B obs-plugin/build \
            -Dlibobs_DIR=$OBS_CMAKE_PREFIX \
            -DCMAKE_PREFIX_PATH="$OBS_CMAKE_PREFIX;/usr/lib/cmake/obs;/usr/lib/x86_64-linux-gnu;/usr/lib/cmake" \
            -DCMAKE_MODULE_PATH="$LOCAL_MODULE;$OBS_CMAKE_MODULE;/usr/lib/cmake/obs"
          cmake --build obs-plugin/build --config Release
          mkdir -p obs-plugin/build/package/obs-mal-scroll/bin/64bit
          cp obs-plugin/build/libobs-mal-scroll.so obs-plugin/build/package/obs-mal-scroll/bin/64bit/
          cd obs-plugin/build/package
          tar -czf ../../obs-mal-scroll-linux.tar.gz obs-mal-scroll

      - name: Download OBS deps (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Download pre-built OBS dependencies
          $OBS_DEPS_VERSION = "2025-08-23"
          Invoke-WebRequest -Uri "https://github.com/obsproject/obs-deps/releases/download/$OBS_DEPS_VERSION/windows-deps-$OBS_DEPS_VERSION-x64.zip" -OutFile "C:/obs-deps.zip"
          Expand-Archive -Path "C:/obs-deps.zip" -DestinationPath "C:/obs-deps" -Force

      - name: Clone and Build OBS libobs (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Clone OBS Studio (shallow, no submodules needed for libobs only)
          git clone --depth 1 --branch 32.0.4 https://github.com/obsproject/obs-studio.git C:/obs-src
          cd C:/obs-src
          # Configure with manual paths to deps
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_PREFIX_PATH="C:/obs-deps" `
            -DCMAKE_SYSTEM_VERSION="10.0" `
            -DENABLE_BROWSER=OFF `
            -DENABLE_WEBSOCKET=OFF `
            -DENABLE_PLUGINS=OFF `
            -DBUILD_BROWSER=OFF
          # Build libobs only
          cmake --build build --config Release --target libobs

      - name: Build OBS Plugin (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (Test-Path obs-plugin/build) { Remove-Item -Recurse -Force obs-plugin/build }
          # Provide source/build hints for fallback finder
          $env:OBS_SOURCE_DIR = "C:/obs-src"
          $env:OBS_BUILD_DIR  = "C:/obs-src"
          cmake -S obs-plugin -B obs-plugin/build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake --build obs-plugin/build --config Release
          mkdir -p obs-plugin/build/package/obs-mal-scroll/bin/64bit
          cp obs-plugin/build/Release/obs-mal-scroll.dll obs-plugin/build/package/obs-mal-scroll/bin/64bit/
          cd obs-plugin/build/package
          powershell Compress-Archive -Force -Path obs-mal-scroll -DestinationPath ../../obs-mal-scroll-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: obs-plugin/${{ matrix.artifact_file }}
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: [build, build-obs-plugin]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
